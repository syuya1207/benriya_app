# ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆãƒ»ä¿å­˜ã™ã‚‹

def create_registration_token(line_user_id):
    """
    auth_tokens ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆãƒ»ä¿å­˜ã™ã‚‹
    """
    # 1. ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚»ã‚­ãƒ¥ã‚¢ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ (64æ–‡å­—)
    access_token = secrets.token_hex(32) # tokenã‚«ãƒ©ãƒ ã®VARCHAR(64)ã«åˆã‚ã›ã‚‹
    
    # 2. ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆæ™‚é–“ã¨æœŸé™åˆ‡ã‚Œæ™‚é–“ã‚’è¨ˆç®—
    created_at = datetime.now()
    expires_at = created_at + timedelta(seconds=constants.TOKEN_EXPIRATION_SECONDS)

    # 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
    # å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†åº¦ã€Œç™»éŒ²ã€ã¨é€ã£ãŸå ´åˆï¼‰
    # user_line_idã§åˆ¤å®š
    DELETE_SQL = "DELETE FROM auth_tokens WHERE user_line_id = %s AND user_id IS NULL;"
    execute_sql(DELETE_SQL, (line_user_id,))
    
    INSERT_SQL = """
    INSERT INTO auth_tokens (token, user_line_id, created_at, expires_at) 
    VALUES (%s, %s, %s, %s);
    """
    result = execute_sql(
        INSERT_SQL, 
        params=(access_token, line_user_id, created_at, expires_at)
    )

    if "success" in result:
        return access_token
    return None



# =========================================================
# 5. ğŸš¨ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã®å‡¦ç†ï¼ˆæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
# =========================================================
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    line_user_id = event.source.user_id
    user_text = event.message.text
    response_text = "ã‚³ãƒãƒ³ãƒ‰ãŒèªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚" 
    
    # ----------------------------------------------------
    # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
    # ----------------------------------------------------
    USER_CHECK_SQL = "SELECT user_id FROM users WHERE user_line_id = %s;"
    user_result = execute_sql(USER_CHECK_SQL, params=(line_user_id,), fetch=True)
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
    if "error" in user_result:
        response_text = f"ğŸš¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚"
        print(f"!!! ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢å¤±æ•—: {user_result['error']} !!!")
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒDBã«è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ (æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼)
    elif not user_result: 
        
        if user_text == constants.USER_KEYWORD_REGISTER:
            if not HOST_URL:
                response_text = "ğŸš¨ è¨­å®šã‚¨ãƒ©ãƒ¼: ãƒ•ã‚©ãƒ¼ãƒ URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            else:
                # â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã€URLã«åŸ‹ã‚è¾¼ã‚€ â˜…â˜…â˜…
                generated_token = create_registration_token(line_user_id)
                if generated_token:
                    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’URLã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨
                    registration_url = f"{HOST_URL}/register_form?token={generated_token}"

                    response_text = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nä»¥ä¸‹ã®URLã‹ã‚‰å¿…è¦äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\n"
                    response_text += registration_url
                    response_text += "\n\nâš ï¸ ã“ã®URLã¯5åˆ†ã§ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚"
                else:
                    response_text = "ğŸš¨ ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚"
        else:
            # ç™»éŒ²èª˜å°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ (å¤‰æ›´ãªã—)
            try:
                profile = line_bot_api.get_profile(line_user_id)
                user_line_name = profile.display_name
            except Exception:
                user_line_name = "ãŠå®¢æ§˜" 
            
            print(f"æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œå‡º: {user_line_name} ({line_user_id})")
            response_text = "{} ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼\nå½“ã‚µãƒ¼ãƒ“ã‚¹ã®ã”åˆ©ç”¨ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚\n\nã€ç™»éŒ²ã€ã¨é€ã£ã¦ã„ãŸã ãã¨ã€ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚".format(user_line_name)
    
    # ----------------------------------------------------
    # 2. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã®å‡¦ç†ï¼ˆçœç•¥ï¼‰
    # ----------------------------------------------------
    else:
        # ... æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯ ...
        user_id = user_result[0]['user_id']
        response_text = f"ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: {user_id} ã®æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚\nãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: '{user_text}' ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚"
            
    # LINEã«å¿œç­”ã‚’è¿”ã™ï¼ˆçœç•¥ï¼‰
    try:
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=response_text)
        )
        print(f"Reply sent successfully. Text: {response_text}")
    except Exception as e:
        print(f"REPLY API ERROR: {e}")


# =========================================================
# 6. æ–°ã—ã„ Flask ãƒ«ãƒ¼ãƒˆã®è¿½åŠ  (ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºç”¨)
# =========================================================
@app.route("/register_form", methods=['GET'])
def display_registration_form():
    """LINEã‹ã‚‰é€ã‚‰ã‚ŒãŸURLã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹"""
    access_token = request.args.get('token')
    
    if not access_token:
        return "ã‚¨ãƒ©ãƒ¼: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚", 400

    # 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œç´¢ã—ã€æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    CHECK_TOKEN_SQL = "SELECT user_line_id FROM auth_tokens WHERE token = %s AND expires_at > NOW();"
    token_result = execute_sql(CHECK_TOKEN_SQL, params=(access_token,), fetch=True)
    
    if not token_result:
        return "ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã‚ã‚‹ã‹ã€æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†åº¦LINEã§ã€Œç™»éŒ²ã€ã¨é€ã£ã¦ãã ã•ã„ã€‚", 403

    # 2. ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ LINE ID ã‚’å–å¾—
    line_user_id = token_result[0]['user_line_id']
    
    # templates/register_form.html ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã€LINE IDã‚’æ¸¡ã™
    return render_template('register_form.html', line_user_id=line_user_id)